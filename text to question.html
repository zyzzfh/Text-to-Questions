<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Quiz Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            padding-top: 60px; /* Space for fixed score tracker */
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }

        /* --- Score Tracker (Pinned at Top) --- */
        #score-tracker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #343a40;
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            justify-content: flex-start; 
            gap: 20px; /* Space between the main blocks */
            align-items: center;
            overflow-x: hidden; /* Prevent horizontal scrolling due to tracker */
        }
        #score-display {
            font-size: 1.0em; /* Slightly smaller to save space */
        }
        /* Style for the central stat summary */
        #stats-summary {
            text-align: left; 
            display: flex; 
            gap: 15px; /* Reduced gap inside stats summary */
            align-items: center;
            flex-shrink: 1; 
            min-width: 0; 
        }
        
        /* --- Percentage Display --- */
        #percentage-display {
            font-size: 1.5em;
            font-weight: bolder;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 90px; 
            text-align: center;
            color: #343a40; 
            flex-shrink: 0;
        }
        /* Color scale for percentage */
        .score-red { background-color: #dc3545; color: white; } /* < 70% */
        .score-orange { background-color: #ffc107; } /* 70% - 79.9% */
        .score-yellow { background-color: #ffeb3b; } /* 80% - 89.9% */
        .score-green { background-color: #28a745; color: white; } /* 90%+ */

        
        /* --- Export Button Style --- */
        #export-button {
            background-color: #ffc107; 
            color: #343a40;
            border: none;
            padding: 8px 15px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }
        #export-button:hover {
            background-color: #e0a800;
        }

        .controls {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #e9e9f1;
            margin-bottom: 20px;
        }
        #load-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        #load-button:hover {
            background-color: #1e7e34;
        }
        #quiz-container {
            margin-top: 10px;
        }

        /* --- Question Styles --- */
        .question-container {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .question-container[data-status="correct"] {
            border-left: 5px solid #28a745;
            background-color: #e6ffe6;
        }
        .question-container[data-status="wrong"] {
            border-left: 5px solid #dc3545;
            background-color: #ffeded;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .options {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options li {
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .options li.highlight {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        /* --- Buttons --- */
        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .reveal-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .reveal-button:hover {
            background-color: #0056b3;
        }
        .score-button {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            font-weight: bold;
        }
        .correct-btn {
            background-color: #28a745;
            color: white;
        }
        .correct-btn:hover {
            background-color: #1e7e34;
        }
        .wrong-btn {
            background-color: #dc3545;
            color: white;
        }
        .wrong-btn:hover {
            background-color: #c82333;
        }
        
        /* --- Answer/Explanation Block --- */
        .answer-explanation {
            display: none; 
            margin-top: 15px;
            padding: 15px;
            background-color: #e9f7ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .explanation-text {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #cce5ff;
            font-size: 0.95em;
        }
        #status-message {
            margin-top: 15px;
            font-style: italic;
            color: #777;
        }
        
        /* --- MOBILE RESPONSIVENESS (Media Query) --- */
        @media screen and (max-width: 850px) {
             body {
                margin: 10px;
                padding-top: 100px; /* Increase space for stacked fixed header */
            }

            /* Stack the fixed score tracker items vertically */
            #score-tracker {
                flex-direction: column; 
                align-items: flex-start; /* Align stacked items to the left */
                gap: 5px; 
                padding: 8px 10px; 
                height: auto; 
            }
            
            /* Center the progress bar text when stacked */
            #score-display {
                width: 100%;
                text-align: left;
                font-size: 1em;
            }
            
            /* Ensure the export button is clear */
            #export-button {
                width: 50%;
                margin-top: 5px;
            }
            
            /* Group stats summary and progress display */
            #stats-summary {
                flex-wrap: wrap; /* Allow stats to wrap if necessary */
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <div id="score-tracker">
        <div id="percentage-display" class="score-red">-- %</div>
        
        <button id="export-button" onclick="exportResults()">Export Results</button>
        
        <div id="stats-summary">
            <span id="score-display">Progress: 0 / 0 Answered</span>
             | Correct: <span id="correct-count">0</span> 
             | Wrong: <span id="wrong-count">0</span> 
             | Total Loaded: <span id="total-count">0</span>
        </div>
    </div>

    <div class="controls">
        <h1>Interactive Quiz Loader</h1>
        <p>Upload your text files below to generate the interactive quiz.</p>
        <label for="file-input" class="file-input-label">Select all question files (e.g., all your .txt files):</label>
        <input type="file" id="file-input" multiple accept=".txt">
        <button id="load-button" onclick="loadAndProcessFiles()">Load and Process Questions</button>
        <div id="status-message">Ready to load files.</div>
    </div>

    <div id="quiz-container">
        </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const quizContainer = document.getElementById('quiz-container');
        const statusMessage = document.getElementById('status-message');
        const correctCountEl = document.getElementById('correct-count');
        const wrongCountEl = document.getElementById('wrong-count');
        const totalCountEl = document.getElementById('total-count');
        const scoreDisplayEl = document.getElementById('score-display');
        const percentageDisplayEl = document.getElementById('percentage-display'); 
        
        // FINAL FIX: Highly specific REGEX using lookaheads (e.g., (?=\s*B\.|\s*Answer:)) for options A through G.
        // This ensures the last option's content is correctly captured right up to the 'Answer:' tag,
        // preventing it from eating up subsequent questions.
        const QUESTION_REGEX = /NEW QUESTION\s*\d+\s*(?:-\s*\(.*?\))?\s*([\s\S]*?)\s*A\.\s*([\s\S]*?)(?=\s*B\.|\s*Answer:)\s*B\.\s*([\s\S]*?)(?=\s*C\.|\s*Answer:)\s*C\.\s*([\s\S]*?)(?=\s*D\.|\s*Answer:)\s*D\.\s*([\s\S]*?)(?=\s*E\.|\s*F\.|\s*G\.|\s*Answer:)\s*(?:\s*E\.\s*([\s\S]*?)(?=\s*F\.|\s*G\.|\s*Answer:))?\s*(?:\s*F\.\s*([\s\S]*?)(?=\s*G\.|\s*Answer:))?\s*(?:\s*G\.\s*([\s\S]*?)(?=\s*Answer:))?\s*Answer:\s*([A-G]+)\s*Explanation:\s*([\s\S]*?)(?=\r?\n\r?\n(NEW QUESTION|\*|Thank You|Relate Links)|$)/gim;

        let totalQuestions = 0;

        // --- Core Quiz Logic ---

        function updateScore() {
            const allQuestions = document.querySelectorAll('.question-container');
            let correct = 0;
            let wrong = 0;
            
            allQuestions.forEach(q => {
                const status = q.getAttribute('data-status');
                if (status === 'correct') {
                    correct++;
                } else if (status === 'wrong') {
                    wrong++;
                }
            });

            totalQuestions = allQuestions.length;
            const answered = correct + wrong;
            
            // Calculate Percentage
            let percentage = 0;
            if (answered > 0) {
                percentage = ((correct / answered) * 100);
            }

            // Update DOM elements
            correctCountEl.textContent = correct;
            wrongCountEl.textContent = wrong;
            totalCountEl.textContent = totalQuestions;
            scoreDisplayEl.textContent = `Progress: ${answered} / ${totalQuestions} Answered`;
            
            // Update Percentage Display
            percentageDisplayEl.textContent = `${percentage.toFixed(1)}%`;
            percentageDisplayEl.className = ''; // Reset classes

            // Apply Color Scaling based on 90% goal
            if (percentage >= 90) {
                percentageDisplayEl.classList.add('score-green');
            } else if (percentage >= 80) {
                percentageDisplayEl.classList.add('score-yellow');
            } else if (percentage >= 70) {
                percentageDisplayEl.classList.add('score-orange');
            } else {
                percentageDisplayEl.classList.add('score-red');
            }
            
            if (answered === 0) {
                percentageDisplayEl.textContent = '-- %';
            }
        }

        function markAnswer(questionId, status) {
            const questionElement = document.getElementById(questionId);
            const currentStatus = questionElement.getAttribute('data-status');
            
            if (currentStatus !== status) {
                questionElement.setAttribute('data-status', status);
            }
            
            const answerBlock = questionElement.querySelector('.answer-explanation');
            const revealButton = questionElement.querySelector('.reveal-button');
            if (answerBlock.style.display === "none" || answerBlock.style.display === "") {
                toggleAnswer(questionId);
                revealButton.textContent = "Hide Answer & Explanation"; 
            }

            updateScore();
            
            const nextQuestion = questionElement.nextElementSibling;
            if (nextQuestion && nextQuestion.classList.contains('question-container')) {
                nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function toggleAnswer(id) {
            const questionElement = document.getElementById(id);
            const answerBlock = questionElement.querySelector('.answer-explanation');
            const revealButton = questionElement.querySelector('.reveal-button');
            // This is now a string (e.g., "C", "CD", "ABF")
            const correctAnswerString = questionElement.getAttribute('data-correct-answer'); 

            if (answerBlock.style.display === "none" || answerBlock.style.display === "") {
                answerBlock.style.display = "block";
                revealButton.textContent = "Hide Answer & Explanation";
                
                // Highlight ALL correct options
                for (const correctOptionLetter of correctAnswerString) {
                    const correctOptionEl = questionElement.querySelector(`#${id}-opt${correctOptionLetter}`);
                    if (correctOptionEl) {
                        correctOptionEl.classList.add('highlight');
                    }
                }
            } else {
                // Hide the answer block
                answerBlock.style.display = "none";
                revealButton.textContent = "Show Answer & Explanation";
                
                // Remove highlight from ALL correct options
                for (const correctOptionLetter of correctAnswerString) {
                    const correctOptionEl = questionElement.querySelector(`#${id}-opt${correctOptionLetter}`);
                    if (correctOptionEl) {
                        correctOptionEl.classList.remove('highlight');
                    }
                }
            }
        }

        // --- Export Function ---
        function exportResults() {
            const correct = parseInt(correctCountEl.textContent);
            const wrong = parseInt(wrongCountEl.textContent);
            const answered = correct + wrong;
            const totalQuestionsLoaded = parseInt(totalCountEl.textContent);
            const allQuestions = document.querySelectorAll('.question-container');

            if (answered === 0) {
                alert("No questions have been answered yet to export results.");
                return;
            }

            // Calculate percentage
            const percentage = ((correct / answered) * 100).toFixed(2); // Two decimal places

            // Get current date and time
            const now = new Date();
            const dateTimeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // 1. Build the Header Content
            let exportContent = `
Quiz Results Export
---------------------------
Date & Time: ${dateTimeString}
Total Questions Loaded: ${totalQuestionsLoaded}

Questions Answered: ${answered} 
Correct Answers: ${correct}
Wrong Answers: ${wrong}

Performance Score: ${percentage}% Correct
---------------------------
`;

            // 2. Build the Wrong Answers Section
            let wrongQuestionsContent = '';
            let wrongCount = 0;
            
            allQuestions.forEach((q) => {
                if (q.getAttribute('data-status') === 'wrong') {
                    wrongCount++;
                    const qText = q.querySelector('.question-text').textContent.trim();
                    const optionsList = Array.from(q.querySelectorAll('.options li')).map(li => li.textContent.trim()).join('\n    ');
                    const correctAnswer = q.getAttribute('data-correct-answer');
                    // Correct selector: '.explanation-text'
                    let explanationText = q.querySelector('.explanation-text').innerHTML.replace(/<br>/g, '\n').replace(/\n\s*\n/g, '\n').trim();

                    wrongQuestionsContent += `
*** INCORRECTLY ANSWERED QUESTION #${wrongCount} ***
Question: ${qText}
Options:
    ${optionsList}
Correct Answer: ${correctAnswer}
Explanation: ${explanationText}
--------------------------------------------------
`;
                }
            });

            // 3. Combine header and wrong questions
            if (wrongCount > 0) {
                exportContent += `\n\n### DETAIL OF INCORRECT ANSWERS (${wrongCount} total) ###\n`;
                exportContent += wrongQuestionsContent;
            } else {
                exportContent += "\n\n### DETAIL OF INCORRECT ANSWERS ###\nNo questions were marked as wrong. Great job!";
            }


            // Create a Blob with the content and trigger download
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_study_guide_${now.toISOString().slice(0, 10)}.txt`; // Changed filename for study guide
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url); 
            alert(`Results and study guide exported successfully! Score: ${percentage}%`);
        }

        // --- File Processing Logic ---

        function loadAndProcessFiles() {
            const files = fileInput.files;
            if (files.length === 0) {
                statusMessage.textContent = "Please select one or more files first.";
                return;
            }

            statusMessage.textContent = `Processing ${files.length} file(s)...`;
            quizContainer.innerHTML = '';
            
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        resolve(event.target.result);
                    };
                    reader.onerror = (error) => {
                        reject(`Error reading file ${file.name}: ${error}`);
                    };
                    reader.readAsText(file);
                });
            });

            Promise.all(filePromises)
                .then(allTextContents => {
                    const combinedText = allTextContents.join('\n\n--- FILE BREAK ---\n\n');
                    const questions = parseQuestions(combinedText);
                    displayQuestions(questions);
                })
                .catch(error => {
                    statusMessage.textContent = `An error occurred: ${error}`;
                    console.error(error);
                });
        }

        function parseQuestions(text) {
            const questionsMap = new Map();
            let match;
            let questionCount = 0;

            // Resetting regex state before starting a new search
            QUESTION_REGEX.lastIndex = 0;

            while ((match = QUESTION_REGEX.exec(text)) !== null) {
                if (match.index === QUESTION_REGEX.lastIndex) {
                    QUESTION_REGEX.lastIndex++;
                }

                // Match groups shifted due to lookaheads being non-capturing, but the optional groups still consume indices 6, 7, 8
                // This means the indices for options A-G (2-8), Answer (9), and Explanation (10) remain the same.

                const clean = (str) => str ? str.trim().replace(/References:[\s\S]*$/, '').trim() : '';
                
                const questionText = clean(match[1]);

                if (questionText.length > 10) { 
                    
                    // Options A, B, C, D are groups 2, 3, 4, 5
                    const options = [
                        clean(match[2]), 
                        clean(match[3]), 
                        clean(match[4]), 
                        clean(match[5])
                    ];
                    
                    // Options E, F, G are optional groups 6, 7, 8
                    if (match[6]) options.push(clean(match[6])); // E
                    if (match[7]) options.push(clean(match[7])); // F
                    if (match[8]) options.push(clean(match[8])); // G

                    const questionKey = questionText.toLowerCase().replace(/[\W_]+/g, ''); 

                    if (!questionsMap.has(questionKey)) {
                        questionCount++;
                        questionsMap.set(questionKey, {
                            id: `q${questionCount}`,
                            text: questionText,
                            options: options,
                            answer: clean(match[9]), // Group 9 is the Answer: [A-G]+
                            explanation: clean(match[10]) // Group 10 is the Explanation
                        });
                    }
                }
            }
            statusMessage.textContent = `Successfully loaded and processed ${questionsMap.size} unique questions.`;
            return Array.from(questionsMap.values());
        }

        function displayQuestions(questions) {
            let html = `<h2>Loaded Quiz (${questions.length} Questions)</h2><hr>`;
            
            questions.forEach((q, index) => {
                const questionNumber = index + 1;
                let optionsHtml = '<ul class="options">';
                // Extended option letters to G
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
                
                q.options.forEach((option, i) => {
                    // Only display if the option exists (i.e., was captured from the text)
                    if (option && optionLetters[i]) {
                        optionsHtml += `<li id="${q.id}-opt${optionLetters[i]}"><strong>${optionLetters[i]}.</strong> ${option}</li>`;
                    }
                });
                optionsHtml += '</ul>';

                html += `
                    <div class="question-container" id="${q.id}" data-correct-answer="${q.answer}" data-status="unanswered">
                        <p class="question-text">${questionNumber}. ${q.text}</p>
                        ${optionsHtml}
                        <div class="button-group">
                            <button class="reveal-button" onclick="toggleAnswer('${q.id}')">Show Answer & Explanation</button>
                            <button class="score-button correct-btn" onclick="markAnswer('${q.id}', 'correct')">I Got It Correct</button>
                            <button class="score-button wrong-btn" onclick="markAnswer('${q.id}', 'wrong')">I Got It Wrong</button>
                        </div>
                        <div class="answer-explanation">
                            <p><strong>Correct Answer: ${q.answer}</strong></p>
                            <p class="explanation-text">${q.explanation.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            });

            quizContainer.innerHTML = html;
            updateScore(); 
            
            fileInput.value = ''; 
        }
        
    </script>

</body>
</html>
